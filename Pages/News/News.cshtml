@page "/News"
@model EHS_Benjamin_Pasic.Pages.News.NewsModel
@{
    ViewData["Title"] = "Latest News";
}

<h2 class="fw-bold mb-3" style="color:#333;">Latest News</h2>

@if (Model.News == null || !Model.News.Any())
{
    <p>No news available.</p>
}
else
{
    <div class="mb-4 d-flex flex-wrap gap-2">
        @foreach (var category in new[] { "Health", "Technology", "Sports", "Business", "Science" })
        {
            var isActive = string.Equals(category.ToLower(), Model.CurrentCategory, StringComparison.OrdinalIgnoreCase);
            <button class="category-btn @(isActive ? "active" : "")" data-category="@category.ToLower()">
                @category
            </button>
        }
    </div>

    <div id="news-container">
        @await Html.PartialAsync("_NewsListPartial", Model.News)
    </div>

}

@section Scripts {
    <script>
        $(document).on("click", ".category-btn", function () {
            $(".category-btn").removeClass("active");
            $(this).addClass("active");

            var category = $(this).data("category");
            $.get(`/News?handler=NewsPartial&category=${category}`, function (data) {
                $("#news-container").html(data);
            });
        });


        $(document).on("click", ".save-btn", function (e) {
            var star = $(this);
            var rawJson = star.attr("data-article");
            var obj = JSON.parse(rawJson);

            if (!obj.image_url || obj.image_url.trim() === "" || obj.image_url.includes("null") || obj.image_url.includes("undefined")) {
                obj.image_url = "/images/default-news.jpeg";
            }

            obj.ArticleId = obj.ArticleId || obj.article_id;

            star.toggleClass("saved");

            if (star.hasClass("saved")) {
                star.text("★");
            } else {
                star.text("☆");
            }

            if (star.data("saved") === true || star.data("saved") === "true") {
          
                $.ajax({
                    url: "/api/NewsApi/delete/" + obj.ArticleId,
                    type: "DELETE",
                    success: function(res) {
                        star.text("☆");
                        star.data("saved", false);
                        showToast(res.msg);
                    },
                    error: function(err) {
                        star.text("★");
                        star.data("saved", true);
                        console.log(err);
                        showToast("Error deleting article.");
                    }
                });
            } else {
                $.ajax({
                    url: "/api/NewsApi/save",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(obj),
                    success: function(res) {
                        star.text("★");
                        star.data("saved", true);
                        showToast(res.msg);
                    },
                    error: function(err) {
                        star.text("☆");
                        star.data("saved", false);
                        console.log(err);
                        showToast("Error saving article.");
                    }
                });
            }
        });

        function showToast(msg) {
            let t = document.createElement("div");
            t.className = "toast-popup";
            t.innerText = msg;

            document.body.appendChild(t);

            setTimeout(() => t.style.opacity = "1", 50);
            setTimeout(() => {
                t.style.opacity = "0";
                setTimeout(() => t.remove(), 300);
            }, 2000);
        }

    </script>
}

