@page
@model EHS_Benjamin_Pasic.Pages.IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="d-flex mb-4" style="gap:15px; height:550px;">
    <div style="flex:0 0 70%;">
        @{
            var hero = Model.News.FirstOrDefault();
        }
        @if (hero != null)
        {
            <div class="hero-news position-relative rounded shadow-sm h-100 overflow-hidden news-card"
                 data-article='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(hero))'>
                <img src="@(string.IsNullOrWhiteSpace(hero.ImageUrl) ? "/images/default-news.jpeg" : hero.ImageUrl)"
                     alt="@hero.Title"
                     class="w-100 h-100"
                     style="object-fit:cover;" />
                <div class="hero-overlay position-absolute p-3 text-white" style="bottom:0; background: rgba(0,0,0,0.7); width:100%;">
                    <h3>@hero.Title</h3>
                    <p>@hero.Description?.Substring(0, Math.Min(120, hero.Description.Length))...</p>
                    <div class="d-flex justify-content-start mt-2">
                        <a href="@hero.Link" target="_blank"
                           class="btn btn-sm btn-light fw-semibold px-3"
                           style="border-radius:20px;">
                            Read more →
                        </a>
                    </div>
                </div>
                @if (User.Identity.IsAuthenticated)
                {
                <span class="star-icon position-absolute hero-star"
                    data-saved="@(        Model.SavedArticleIds.Contains(hero.ArticleId) ? "true" : "false")">
                        @(        Model.SavedArticleIds.Contains(hero.ArticleId) ? "★" : "☆")
                    </span>
                }
            </div>
        }
    </div>

    <div style="flex:0 0 30%; overflow-y:auto; max-height:550px; overflow-x:hidden;">
        @foreach (var item in Model.News.Skip(1).Take(8))
        {
            <div class="mini-news p-2 mb-3 rounded shadow-sm news-card"
                 style="background:#f9f9f9;"
                 data-article='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(item))'>
                <img src="@(string.IsNullOrWhiteSpace(item.ImageUrl) ? "/images/default-news.jpeg" : item.ImageUrl)"
                     alt="@item.Title"
                     onerror="this.onerror=null; this.src='/images/default-news.jpeg';"
                     class="img-fluid w-100 mb-2"
                     style="height:100px; object-fit:cover; border-radius:6px;" />
                <h6 class="small-news-title">@item.Title</h6>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <span class="star-icon"
                        style="font-size:26px; cursor:pointer;"
                        data-saved="@(        Model.SavedArticleIds.Contains(item.ArticleId) ? "true" : "false")">
                            @(        Model.SavedArticleIds.Contains(item.ArticleId) ? "★" : "☆")
                        </span>
                    }

                    <a href="@item.Link" target="_blank"
                       class="btn btn-sm fw-semibold"
                       style="border-radius: 20px; background:#8e63ff; color:white; padding:3px 12px;">
                        Open →
                    </a>
                </div>

            </div>
        }
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="info-card text-center p-4">
            <h4 class="mb-2">View All News</h4>
            <p class="text-muted mb-3">Browse all categories and explore the latest updates.</p>
            <a href="/News" class="btn btn-gradient">Go to News</a>
        </div>
    </div>

    <div class="col-md-6">
        <div class="info-card text-center p-4">
            <h4 class="mb-2">View Saved News</h4>
            <p class="text-muted mb-3">Check your saved articles and continue reading later.</p>
            <a href="/SavedNews" class="btn btn-gradient">Go to Saved News</a>
        </div>
    </div>
</div>

@section Scripts {
    @if (User.Identity.IsAuthenticated)
    {
    <script>
        $(document).on("click", ".star-icon", function () {
            var star = $(this);
            var card = star.closest(".news-card");
            var rawJson = card.attr("data-article");
            var obj = JSON.parse(rawJson);

            if (!obj.image_url || obj.image_url.trim() === "" || obj.image_url.includes("null") || obj.image_url.includes("undefined")) {
                obj.image_url = "/images/default-news.jpeg";
            }

            obj.ArticleId = obj.ArticleId || obj.article_id;

            if (star.data("saved") === true || star.data("saved") === "true") {
                $.ajax({
                    url: "/api/NewsApi/delete/" + obj.ArticleId,
                    type: "DELETE",
                    success: function(res) {
                        star.text("☆");
                        star.data("saved", false);
                        showToast("Removed from saved", "success");
                    },
                    error: function(err) {
                        showToast("Error removing article", "danger");
                    }
                });
            } else {
                $.ajax({
                    url: "/api/NewsApi/save",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(obj),
                    success: function(res) {
                        star.text("★");
                        star.data("saved", true);
                        showToast("Saved article", "success");
                    },
                    error: function(err) {
                        showToast("Error saving article", "danger");
                    }
                });
            }
        });
    </script>
    }
}
